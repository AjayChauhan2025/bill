<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
   

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .sidebar {
            width: 200px;
            height: 100vh;
            background: #343a40;
            color: white;
            padding: 15px 10px;
            position: fixed;
        }

            .sidebar button {
                width: 100%;
                margin: 8px 0;
                font-size: 14px;
            }

        .content {
            margin-left: 200px;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        .stat-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
            padding: 20px;
            font-weight: bold;
        }

        .stat-box {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

            .stat-box:hover {
                transform: translateY(-3px);
                box-shadow: 2px 4px 12px rgba(0,0,0,0.15);
            }

        small {
            display: block;
            margin-top: 5px;
            text-align: center;
            font-size: 14px;
            color: #555;
        }

        #deptCheckbox, #productCheckbox, #processCheckbox {
            max-height: 180px; /* adjust height */
            overflow-y: auto;
            padding-right: 5px; /* optional, avoid scrollbar overlapping */
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <div class="sidebar">
            <h5>Admin Panel</h5>
            <button class="btn btn-light btn-sm" onclick="showSection('dashboard')">Dashboard</button>
            <button class="btn btn-light btn-sm" onclick="showSection('addMaster')">Add Master</button>
            <button class="btn btn-light btn-sm" onclick="showSection('addparty')">Add Party</button>
            <button class="btn btn-light btn-sm" onclick="showSection('userManage')">User Manage</button>
            <button class="btn btn-light btn-sm" onclick="showSection('viewBill')">View Bill</button>
            <!-- ✅ New GST Bills Button -->
            <button class="btn btn-light btn-sm" onclick="showSection('viewGSTBills'); loadGSTBills()">View GST Bills</button>
            <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>

        </div>


        <!-- Main Content -->
        <div class="content flex-grow-1">

            <!-- Dashboard -->
            <div id="dashboard">
                <h4>Dashboard</h4>
                <div class="row g-3">
                    <div class="col-md-3"><div class="stat-box" id="totalBills">0</div><small>Total Bills</small></div>
                    <div class="col-md-3"><div class="stat-box" id="totalAmount">₹0</div><small>Total Amount</small></div>
                    <div class="col-md-3"><div class="stat-box" id="paidAmount">₹0</div><small>Paid</small></div>
                    <div class="col-md-3"><div class="stat-box" id="unpaidAmount">₹0</div><small>Unpaid</small></div>
                </div>
                <div class="mt-3"><button class="btn btn-primary" onclick="refreshDashboard()">🔄 Refresh</button></div>
                <h5 class="mt-4">Department Wise Totals</h5>
                <div class="row g-3" id="dashboardSummary">
                    <div class="col-md-3">
                        <div class="stat-box" id="totalBills"></div>
                        <small>Department Name</small> <!-- Bills count hatavi ne department name -->
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box" id="totalAmount">₹0</div>
                        <small>Total Amount</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box" id="paidAmount">₹0</div>
                        <small>Paid</small>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box" id="unpaidAmount">₹0</div>
                        <small>Unpaid</small>
                    </div>
                </div>


            </div>

            <!-- Add Master -->
            <div id="addMaster" class="hidden">
                <h4>Add Master</h4>

                <!-- Forms -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <form id="deptForm" class="d-flex gap-2">
                            <input type="text" id="deptName" class="form-control form-control-sm" placeholder="New Department" required>
                            <button type="submit" class="btn btn-success btn-sm">Save</button>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <form id="productForm" class="d-flex gap-2">
                            <input type="text" id="productName" class="form-control form-control-sm" placeholder="New Product" required>
                            <button type="submit" class="btn btn-success btn-sm">Save</button>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <form id="processForm" class="d-flex gap-2">
                            <input type="text" id="processName" class="form-control form-control-sm" placeholder="New Process" required>
                            <button type="submit" class="btn btn-success btn-sm">Save</button>
                        </form>
                    </div>
                </div>

                <!-- Group Boxes -->
                <div class="row">
                    <div class="col-md-4">
                        <fieldset class="border p-3 rounded">
                            <legend class="float-none w-auto">Departments</legend>
                            <div id="deptCheckbox"></div>
                        </fieldset>
                    </div>
                    <div class="col-md-4">
                        <fieldset class="border p-3 rounded">
                            <legend class="float-none w-auto">Products</legend>
                            <div id="productCheckbox"></div>
                        </fieldset>
                    </div>
                    <div class="col-md-4">
                        <fieldset class="border p-3 rounded">
                            <legend class="float-none w-auto">Processes</legend>
                            <div id="processCheckbox"></div>
                        </fieldset>
                    </div>
                </div>

                <!-- Save Mapping Button -->
                <div class="text-center mt-3">
                    <button id="saveMapping" class="btn btn-primary btn-sm">Save Mapping</button>
                </div>

                <!-- DataGrid -->
                <h4 class="mt-4">Saved Mappings</h4>
                <table class="table table-bordered" id="mappingTable">
                    <thead class="table-light">
                        <tr>
                            <th>Department</th>
                            <th>Product</th>
                            <th>Process</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Add Party Section -->
            <div id="addparty" class="content-section hidden">
                <h4>Add Party</h4>
                <form id="partyForm" class="row g-2 mb-3">
                    <div class="col-md-4">
                        <input type="text" id="partyName" class="form-control" placeholder="Party Name" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="partyContact" class="form-control" placeholder="Contact Number">
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="partyAddress" class="form-control" placeholder="Address">
                    </div>
                    <div class="col-md-12 mt-2">
                        <button type="submit" class="btn btn-success btn-sm">Add Party</button>
                    </div>
                </form>

                <!-- Party List -->
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Party Name</th>
                            <th>Contact</th>
                            <th>Address</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="partyTable"></tbody>
                </table>
            </div>


            <!-- User Manage Section -->
            <div id="userManage" class="hidden">
                <h4>User Manage</h4>
                <form id="userForm" class="row g-2 mb-3">
                    <div class="col-md-3">
                        <select id="userDept" class="form-control form-select form-select-sm" required>
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    <div class="col-md-3"><input type="text" id="fullName" class="form-control form-control-sm" placeholder="Full Name" required></div>
                    <div class="col-md-3"><input type="text" id="username" class="form-control form-control-sm" placeholder="Username" required></div>
                    <div class="col-md-3"><input type="password" id="password" class="form-control form-control-sm" placeholder="Password" required></div>
                    <div class="col-md-2 mt-2">
                        <button type="submit" class="btn btn-success btn-sm w-100">Save User</button>
                    </div>
                </form>

                <table class="table table-bordered table-sm">
                    <thead>
                        <tr><th>Department</th><th>Full Name</th><th>Username</th><th>Password</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>



            <!-- View Bill -->
            <div id="viewBill" class="hidden">
                <h4>All Bills</h4>

                <!-- Filters -->
                <div class="row g-2 mb-3">
                    <div class="col-md-2">
                        <select id="filterMonth" class="form-control">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select id="filterDepartment" class="form-control">
                            <option value="">All Departments</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select id="filterParty" class="form-control">
                            <option value="">All Parties</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select id="filterProduct" class="form-control">
                            <option value="">All Products</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select id="filterStatus" class="form-control">
                            <option value="">All Status</option>
                            <option value="Paid">Paid</option>
                            <option value="Unpaid">Unpaid</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyBillFilters()">Filter</button>
                    </div>
                    <!-- Refresh Button -->
                    <div class="mb-2">
                        <button class="btn btn-secondary" onclick="refreshBillTable()">🔄 Refresh</button>
                    </div>

                </div>

                <!-- Table -->
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllBills"></th>
                            <th>Department</th>
                            <th>Date</th>
                            <th>Bill No</th>
                            <th>Party</th>
                            <th>Product</th>
                            <th>PCS</th>
                            <th>Rate</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Remark</th>
                            <th>Bill</th>
                        </tr>
                    </thead>
                    <tbody id="billTableBody"></tbody>
                </table>
                <button class="btn btn-success mt-2" onclick="convertToGST()">Convert to GST</button>
                <!-- Modal for Bill Preview -->
                <div class="modal fade" id="billModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bill Preview</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="billImage" src="" class="img-fluid" alt="Bill Image">
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <!-- View GST Bills -->
            <div id="viewGSTBills" class="hidden">
                <h4>GST Bills</h4>

                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Party Name</th>
                            <th>Included Bills</th>
                            <th>Sub Total</th>
                            <th>GST (%)</th>
                            <th>Grand Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="gstBillTable"></tbody>
                </table>
            </div>






        </div>
    </div>

   
    <script type="module">

        window.showSection = function (sectionId) {
            // બધી sections hide કરો
            document.querySelectorAll(".content > div").forEach(div => {
                div.classList.add("hidden");
            });

            // પસંદ કરેલી section show કરો
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove("hidden");
            }
        };
        

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            getDoc
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        /* ===========================
           Firebase configuration
           ===========================
           Replace this firebaseConfig with your project's configuration.
           You already provided an example in your previous code — keep that here.
        */
        const firebaseConfig = {
            apiKey: "AIzaSyA1arlDFhHRjH4aACZUnDFGHjZcHNStZLg",
            authDomain: "bill-74883.firebaseapp.com",
            projectId: "bill-74883",
            storageBucket: "bill-74883.appspot.com",
            messagingSenderId: "1013144600935",
            appId: "1:1013144600935:web:4a6d8e11b2482e482aefc2",
            measurementId: "G-SX7Z75FG55"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        /* ===========================
           In-memory arrays (replacing localStorage arrays)
           These arrays are updated via onSnapshot (real-time).
           We keep them so existing render functions and index-based edits still work.
           =========================== */
        let departmentsArr = [];
        let productsArr = [];
        let processesArr = [];
        let mappingsArr = [];   // mapping objects: { id, dept, product, process }
        let partyListArr = [];  // parties stored as docs in 'parties' collection
        let usersArr = [];
        let billsArr = [];
        let gstBillsArr = [];

        /* Utility: map a storageKey used in your original code to Firestore collection name */
        function collNameFromKey(key) {
            switch (key) {
                case 'departments': return 'departments';
                case 'products': return 'products';
                case 'processes': return 'processes';
                case 'mappings': return 'mappings';
                case 'partyList': return 'parties';
                case 'users': return 'users';
                case 'bills': return 'bills';
                case 'gstBills': return 'gstBills';
                default: return key;
            }
        }

        /* ===========================
           Real-time listeners (onSnapshot)
           Keep the arrays in sync with Firestore.
           We order by createdAt to give stable order and mimic array ordering.
           =========================== */
        function initRealtimeListeners() {
            // departments
            onSnapshot(query(collection(db, 'departments')), snapshot => {

                departmentsArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // existing code expects simple string names in departments array
                // but renderGroupBox and other code use the array items as plain names.
                // So when calling renderGroupBox we pass storageKey 'departments' (below),
                // and renderGroupBox reads departmentsArr to build UI.
                renderGroupBox('deptCheckbox', 'departments');
                loadUserDepartments();
                refreshDashboard();
                loadFilterDropdowns();
            });

            // products
            onSnapshot(query(collection(db, 'products'), orderBy('createdAt')), snapshot => {
                productsArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderGroupBox('productCheckbox', 'products');
                loadFilterDropdowns();
            });

            // processes
            onSnapshot(query(collection(db, 'processes'), orderBy('createdAt')), snapshot => {
                processesArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderGroupBox('processCheckbox', 'processes');
                loadFilterDropdowns();
            });

            // mappings
            onSnapshot(query(collection(db, 'mappings'), orderBy('createdAt')), snapshot => {
                mappingsArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadMappings();
            });

            // parties
            onSnapshot(query(collection(db, 'parties'), orderBy('createdAt')), snapshot => {
                partyListArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderPartyTable(); // uses partyListArr now
                loadFilterDropdowns();
            });

            // users
            onSnapshot(query(collection(db, 'users'), orderBy('createdAt')), snapshot => {
                usersArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadUsers();
            });

            // bills
            onSnapshot(query(collection(db, 'bills'), orderBy('createdAt')), snapshot => {
                billsArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // keep the old global `bills` variable used across functions for compatibility
                window.bills = billsArr.map(b => ({ ...b })); // shallow map to match previous structure
                displayBills(window.bills);
                loadAdminBills();
                refreshDashboard();
                updateBillStatus();
                loadFilterDropdowns();
            });

            // gstBills
            onSnapshot(query(collection(db, 'gstBills'), orderBy('createdAt')), snapshot => {
                gstBillsArr = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadGSTBills();
            });
        }

        /* ===========================
           Helper: add group item (dept/product/process)
           Matches signature of your original addItemWithActions but writes to Firestore
           =========================== */
        function addItemWithActions(formId, inputId, containerId, storageKey) {
            const form = document.getElementById(formId);
            const input = document.getElementById(inputId);
            if (!form || !input) return; // defensive

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                let value = input.value.trim();
                if (!value) return;

                // determine which collection
                const coll = collNameFromKey(storageKey);

                // check duplicate in current array (case-insensitive)
                const arr = (storageKey === 'departments') ? departmentsArr :
                    (storageKey === 'products') ? productsArr :
                        (storageKey === 'processes') ? processesArr : [];

                if (arr.some(x => (x.name || x).toLowerCase() === value.toLowerCase())) {
                    alert("⚠️ Already exists!");
                    return;
                }

                try {
                    // add doc in Firestore
                    await addDoc(collection(db, coll), {
                        name: value,
                        createdAt: serverTimestamp() || new Date()
                    });

                    input.value = "";
                    // UI will update via the onSnapshot listener
                } catch (err) {
                    console.error("Error adding item:", err);
                    alert("❌ Error saving item. Check console.");
                }
            });
        }

        /* ===========================
           Render GroupBox items with Edit/Delete buttons
           Now reads from the in-memory arrays updated by Firestore snapshots.
           containerId and storageKey are the same as before.
           =========================== */
        function renderGroupBox(containerId, storageKey) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";

            let items = [];
            if (storageKey === 'departments') items = departmentsArr.map(a => ({ id: a.id, name: a.name }));
            if (storageKey === 'products') items = productsArr.map(a => ({ id: a.id, name: a.name }));
            if (storageKey === 'processes') items = processesArr.map(a => ({ id: a.id, name: a.name }));

            items.forEach((item, index) => {
                const safeId = `${containerId}_${index}`;
                const div = document.createElement("div");
                div.className = "form-check d-flex align-items-center justify-content-between mb-1";
                div.innerHTML = `
                <div>
                    <input type="checkbox" class="form-check-input me-1" value="${item.name}" id="${safeId}">
                    <label class="form-check-label" for="${safeId}">${item.name}</label>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-1" onclick="editGroupItem('${storageKey}',${index},'${containerId}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteGroupItem('${storageKey}',${index},'${containerId}')">Delete</button>
                </div>`;
                container.appendChild(div);
            });
        }

        /* ===========================
           Edit group item
           Prompts the user and updates Firestore doc for that item.
           =========================== */
        window.editGroupItem = async function (storageKey, index, containerId) {
            // find item id
            let arr = (storageKey === 'departments') ? departmentsArr :
                (storageKey === 'products') ? productsArr :
                    (storageKey === 'processes') ? processesArr : [];

            const item = arr[index];
            if (!item) return alert("Item not found.");

            let newValue = prompt("Edit value:", item.name);
            if (!newValue) return;
            newValue = newValue.trim();
            if (!newValue) return;

            // check duplicates
            if (arr.some((x, i) => i !== index && (x.name || x).toLowerCase() === newValue.toLowerCase())) {
                return alert("⚠️ Already exists!");
            }

            try {
                // update Firestore doc
                await setDoc(doc(db, collNameFromKey(storageKey), item.id), {
                    name: newValue,
                    createdAt: item.createdAt || serverTimestamp()
                }, { merge: true });
                // onSnapshot will re-render
            } catch (err) {
                console.error("Error updating item:", err);
                alert("❌ Error updating item.");
            }
        };

        /* ===========================
           Delete group item
           Deletes Firestore doc.
           =========================== */
        window.deleteGroupItem = async function (storageKey, index, containerId) {
            if (!confirm("Are you sure to delete?")) return;

            let arr = (storageKey === 'departments') ? departmentsArr :
                (storageKey === 'products') ? productsArr :
                    (storageKey === 'processes') ? processesArr : [];

            const item = arr[index];
            if (!item) return alert("Item not found.");

            try {
                await deleteDoc(doc(db, collNameFromKey(storageKey), item.id));
                // onSnapshot will re-render
            } catch (err) {
                console.error("Error deleting item:", err);
                alert("❌ Error deleting item.");
            }
        };

        /* ===========================
           Mappings: Save / Load / Edit / Delete
           mappingsArr holds mapping docs { id, dept, product, process }.
           We preserve the edit-by-index behaviour by using mappingsArr[editIndex].id
           =========================== */
        document.getElementById('saveMapping')?.addEventListener('click', async () => {
            const getChecked = id => [...document.querySelectorAll(`#${id} input:checked`)].map(c => c.value).join(", ");

            const dept = getChecked("deptCheckbox");
            const product = getChecked("productCheckbox");
            const process = getChecked("processCheckbox");

            if (!dept || !product || !process) {
                alert("⚠️ Please select Department, Product and Process");
                return;
            }

            try {
                const editIndex = document.getElementById('saveMapping').dataset.editIndex;
                if (editIndex != null && mappingsArr[editIndex]) {
                    // update existing mapping document
                    const docId = mappingsArr[editIndex].id;
                    await setDoc(doc(db, 'mappings', docId), {
                        dept, product, process, createdAt: mappingsArr[editIndex].createdAt || serverTimestamp()
                    }, { merge: true });
                    delete document.getElementById('saveMapping').dataset.editIndex;
                } else {
                    // create new mapping
                    await addDoc(collection(db, 'mappings'), { dept, product, process, createdAt: serverTimestamp() });
                }

                // Uncheck all after save
                document.querySelectorAll('#deptCheckbox input,#productCheckbox input,#processCheckbox input').forEach(c => c.checked = false);

                // UI updates via onSnapshot
            } catch (err) {
                console.error("Error saving mapping:", err);
                alert("❌ Error saving mapping.");
            }
        });

        function loadMappings() {
            const tbody = document.querySelector("#mappingTable tbody");
            if (!tbody) return;
            tbody.innerHTML = '';

            mappingsArr.forEach((m, index) => {
                tbody.innerHTML += `
             <tr>
                 <td>${m.dept}</td>
                 <td>${m.product}</td>
                 <td>${m.process}</td>
                 <td>
                     <button class="btn btn-sm btn-primary me-1" onclick="editMapping(${index})">Edit</button>
                     <button class="btn btn-sm btn-danger" onclick="deleteMapping(${index})">Delete</button>
                 </td>
             </tr>`;
            });
        }

        window.editMapping = function (index) {
            const m = mappingsArr[index];
            if (!m) return alert("Mapping not found.");

            // check items which match stored mapping
            document.querySelectorAll('#deptCheckbox input').forEach(c => c.checked = m.dept.split(", ").includes(c.value));
            document.querySelectorAll('#productCheckbox input').forEach(c => c.checked = m.product.split(", ").includes(c.value));
            document.querySelectorAll('#processCheckbox input').forEach(c => c.checked = m.process.split(", ").includes(c.value));

            document.getElementById('saveMapping').dataset.editIndex = index;
        };

        window.deleteMapping = async function (index) {
            if (!confirm("Are you sure you want to delete this mapping?")) return;
            const m = mappingsArr[index];
            if (!m) return alert("Mapping not found.");
            try {
                await deleteDoc(doc(db, 'mappings', m.id));
            } catch (err) {
                console.error("Error deleting mapping:", err);
                alert("❌ Error deleting mapping.");
            }
        };

        /* ===========================
           Dept mapping for user (same logic as before but reading mappingsArr)
           =========================== */
        function getDeptMapping(dept) {
            let related = mappingsArr.filter(m => m.dept.includes(dept));
            return {
                products: [...new Set(related.map(m => m.product).join(", ").split(", ").filter(Boolean))],
                processes: [...new Set(related.map(m => m.process).join(", ").split(", ").filter(Boolean))]
            };
        }

        /* ===========================
           Dashboard: refreshDashboard
           Reads billsArr and departmentsArr instead of localStorage
           =========================== */
        function refreshDashboard() {
            let bills = billsArr || [];

            // Overall totals
            let total = 0, paid = 0, unpaid = 0;
            bills.forEach(b => {
                let amt = parseFloat(b.total) || 0;
                total += amt;
                if (b.status === "Paid") paid += amt; else unpaid += amt;
            });
            document.getElementById('totalBills') && (document.getElementById('totalBills').innerText = bills.length);
            document.getElementById('totalAmount') && (document.getElementById('totalAmount').innerText = "₹" + total);
            document.getElementById('paidAmount') && (document.getElementById('paidAmount').innerText = "₹" + paid);
            document.getElementById('unpaidAmount') && (document.getElementById('unpaidAmount').innerText = "₹" + unpaid);

            // Department-wise totals
            let departments = departmentsArr.map(d => d.name || d);
            const summaryDiv = document.getElementById('dashboardSummary');
            if (!summaryDiv) return;
            summaryDiv.innerHTML = ""; // Clear old summary

            departments.forEach(dept => {
                let deptBills = bills.filter(b => b.dept === dept);
                let deptTotal = deptBills.reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0);
                let deptPaid = deptBills.filter(b => b.status === "Paid").reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0);
                let deptUnpaid = deptBills.filter(b => b.status !== "Paid").reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0);
                let deptCount = deptBills.length;

                // Create stat boxes dynamically (same output as before)
                summaryDiv.innerHTML += `
<div class="col-md-3">
            <div class="stat-box">${dept}</div>
</div>
<div class="col-md-3">
            <div class="stat-box">₹${deptTotal}</div>
</div>
<div class="col-md-3">
            <div class="stat-box">₹${deptPaid}</div>
</div>
<div class="col-md-3">
            <div class="stat-box">₹${deptUnpaid}</div>
</div>
`;
            });
        }

        /* ===========================
           Party management (parties collection)
           renderPartyTable, add/edit/delete party
           =========================== */
        function renderPartyTable() {
            let table = document.getElementById("partyTable");
            if (!table) return;
            table.innerHTML = "";
            partyListArr.forEach((p, index) => {
                let row = `<tr>
                 <td>${index + 1}</td>
                 <td>${p.name}</td>
                 <td>${p.contact}</td>
                 <td>${p.address}</td>
                 <td>
                     <button class="btn btn-warning btn-sm" onclick="editParty(${index})">Edit</button>
                     <button class="btn btn-danger btn-sm" onclick="deleteParty(${index})">Delete</button>
                 </td>
             </tr>`;
                table.innerHTML += row;
            });
        }

        document.getElementById("partyForm")?.addEventListener("submit", async function (e) {
            e.preventDefault();
            let name = document.getElementById("partyName").value.trim();
            let contact = document.getElementById("partyContact").value.trim();
            let address = document.getElementById("partyAddress").value.trim();

            if (!name) return alert("⚠️ Party Name required!");

            try {
                await addDoc(collection(db, 'parties'), { name, contact, address, createdAt: serverTimestamp() });
                this.reset();
                // UI updates via onSnapshot
            } catch (err) {
                console.error("Error saving party:", err);
                alert("❌ Error saving party.");
            }
        });

        window.deleteParty = async function (index) {
            if (!confirm("Are you sure you want to delete this party?")) return;
            const p = partyListArr[index];
            if (!p) return alert("Party not found.");
            try {
                await deleteDoc(doc(db, 'parties', p.id));
            } catch (err) {
                console.error("Error deleting party:", err);
                alert("❌ Error deleting party.");
            }
        };

        window.editParty = function (index) {
            let p = partyListArr[index];
            if (!p) return alert("Party not found.");
            document.getElementById("partyName").value = p.name;
            document.getElementById("partyContact").value = p.contact;
            document.getElementById("partyAddress").value = p.address;

            // Remove the original doc so when user submits new one it's effectively an edit.
            // Better approach: store doc id in a data attribute and perform setDoc on submit.
            // For simplicity and to preserve the previous flow we'll delete the doc now and on submit a new doc is created.
            // (This mirrors your earlier behavior which removed the item and re-added.)
            deleteDoc(doc(db, 'parties', p.id)).catch(err => {
                console.warn("Could not delete party immediately; will be overwritten on submit.", err);
            });
        };

        /* ===========================
           Filter dropdowns: departments / parties / products
           These load from the in-memory arrays (Firestore data)
           =========================== */
        function loadFilterDropdowns() {
            // Departments
            let depts = departmentsArr.map(d => d.name || d);
            let deptSel = document.getElementById("filterDepartment");
            if (deptSel) {
                deptSel.innerHTML = '<option value="">All Departments</option>';
                depts.forEach(d => deptSel.innerHTML += `<option value="${d}">${d}</option>`);
            }

            // Parties
            let parties = partyListArr.map(p => p.name);
            let partySel = document.getElementById("filterParty");
            if (partySel) {
                partySel.innerHTML = '<option value="">All Parties</option>';
                parties.forEach(p => partySel.innerHTML += `<option value="${p}">${p}</option>`);
            }

            // Products
            let products = productsArr.map(p => p.name || p);
            let prodSel = document.getElementById("filterProduct");
            if (prodSel) {
                prodSel.innerHTML = '<option value="">All Products</option>';
                products.forEach(p => prodSel.innerHTML += `<option value="${p}">${p}</option>`);
            }
        }

        /* ===========================
           Bills: display, admin view, update status, filters
           These use billsArr (Firestore) instead of localStorage.
           =========================== */
        function displayBills(data) {
            const tbody = document.getElementById("billTableBody");
            if (!tbody) return;
            tbody.innerHTML = "";
            data.forEach((bill, index) => {
                const row = `<tr>
                <td><input type="checkbox" class="billCheck" data-index="${index}"></td>
                <td>${bill.dept || ""}</td>
                <td>${bill.date || ""}</td>
                <td>${bill.billNo || ""}</td>
                <td>${bill.party || ""}</td>
                <td>${bill.product || ""}</td>
                <td>${bill.pcs || ""}</td>
                <td>${bill.rate || ""}</td>
                <td>${bill.total || ""}</td>
                <td>${bill.status || ""}</td>
                <td>${bill.remark || ""}</td>
                <td>
                    ${bill.photo
                        ? `<button class="btn btn-sm btn-info" onclick="openBillModal('${bill.photo}')">View Bill</button>`
                        : `<span class="text-muted">No File</span>`}
                </td>
            </tr>`;
                tbody.innerHTML += row;
            });
        }

        function openBillModal(photoUrl) {
            document.getElementById("billImage").src = photoUrl;
            var modalEl = document.getElementById('billModal');
            if (!modalEl) return;
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        function loadAdminBills() {
            const tbody = document.getElementById('adminBillTableBody');
            if (!tbody) return;
            tbody.innerHTML = "";
            billsArr.forEach(b => {
                tbody.innerHTML += `<tr>
                    <td>${b.date || ""}</td>
                    <td>${b.billNo || ""}</td>
                    <td>${b.party || ""}</td>
                    <td>${b.product || ""}</td>
                    <td>${b.pcs || ""}</td>
                    <td>${b.rate || ""}</td>
                    <td>${b.total || ""}</td>
                    <td>${b.status || ""}</td>
                    <td>${b.dept || ""}</td>
                </tr>`;
            });
        }

        window.updateBillStatus = function () {
            const tbody = document.getElementById("billTableBody");
            if (!tbody) return;
            billsArr.forEach((b, index) => {
                const row = tbody.rows[index];
                if (row) {
                    row.cells[9].innerText = b.status || "Pending";
                    const checkbox = row.cells[0].querySelector("input.billCheck");
                    if (checkbox) {
                        checkbox.disabled = b.status === "Paid GST";
                    }
                }
            });
        };

        function applyBillFilters() {
            let month = document.getElementById("filterMonth")?.value || "";
            let department = document.getElementById("filterDepartment")?.value || "";
            let party = document.getElementById("filterParty")?.value || "";
            let product = document.getElementById("filterProduct")?.value || "";
            let status = document.getElementById("filterStatus")?.value || "";

            let filtered = (billsArr || []).filter(bill => {
                let billDate = bill.date ? new Date(bill.date) : null;
                let billMonth = billDate ? String(billDate.getMonth() + 1).padStart(2, "0") : "";

                return (
                    (month === "" || billMonth === month) &&
                    (department === "" || bill.dept === department) &&
                    (party === "" || bill.party === party) &&
                    (product === "" || bill.product === product) &&
                    (status === "" || bill.status === status)
                );
            });

            displayBills(filtered);
        }

        /* ===========================
           Users: Save / Load / Edit / Delete -> Firestore 'users' collection
           =========================== */
        document.getElementById('userForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            let usersLocal = usersArr || [];

            let newUser = {
                dept: document.getElementById('userDept')?.value || "",
                fullName: document.getElementById('fullName')?.value.trim() || "",
                username: document.getElementById('username')?.value.trim() || "",
                password: document.getElementById('password')?.value.trim() || ""
            };

            if (!newUser.dept || !newUser.fullName || !newUser.username || !newUser.password) {
                alert("⚠️ Please fill all fields!");
                return;
            }

            try {
                const editIndex = this.dataset.editIndex;
                if (editIndex != undefined && usersArr[editIndex]) {
                    // update existing user doc
                    const docId = usersArr[editIndex].id;
                    await setDoc(doc(db, 'users', docId), { ...newUser, createdAt: usersArr[editIndex].createdAt || serverTimestamp() }, { merge: true });
                    delete this.dataset.editIndex;
                } else {
                    await addDoc(collection(db, 'users'), { ...newUser, createdAt: serverTimestamp() });
                }
                this.reset();
            } catch (err) {
                console.error("Error saving user:", err);
                alert("❌ Error saving user.");
            }
        });

        function loadUsers() {
            const tbody = document.getElementById('userTable');
            if (!tbody) return;
            tbody.innerHTML = '';

            usersArr.forEach((u, index) => {
                tbody.innerHTML += `
                <tr>
                    <td>${u.dept}</td>
                    <td>${u.fullName}</td>
                    <td>${u.username}</td>
                    <td>${u.password}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editUser(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${index})">Delete</button>
                    </td>
                </tr>`;
            });
        }

        function loadUserDepartments() {
            let depts = departmentsArr.map(d => d.name || d);
            const select = document.getElementById('userDept');
            if (!select) return;
            select.innerHTML = '<option value="">Select Department</option>';
            depts.forEach(d => {
                select.innerHTML += `<option value="${d}">${d}</option>`;
            });
        }

        window.loadUserDeptItems = function (username) {
            let user = usersArr.find(u => u.username === username);
            if (!user) return;

            let mapping = getDeptMapping(user.dept);

            const prodSelect = document.getElementById('productDropdown');
            if (prodSelect) {
                prodSelect.innerHTML = '<option value="">Select Product</option>';
                mapping.products.forEach(p => prodSelect.innerHTML += `<option value="${p}">${p}</option>`);
            }

            const procSelect = document.getElementById('processDropdown');
            if (procSelect) {
                procSelect.innerHTML = '<option value="">Select Process</option>';
                mapping.processes.forEach(p => procSelect.innerHTML += `<option value="${p}">${p}</option>`);
            }
        };

        window.editUser = function (index) {
            let u = usersArr[index];
            if (!u) return alert("User not found.");

            document.getElementById('userDept').value = u.dept;
            document.getElementById('fullName').value = u.fullName;
            document.getElementById('username').value = u.username;
            document.getElementById('password').value = u.password;

            document.getElementById('userForm').dataset.editIndex = index;
        };

        window.deleteUser = async function (index) {
            if (!confirm("Are you sure to delete this user?")) return;
            let u = usersArr[index];
            if (!u) return alert("User not found.");
            try {
                await deleteDoc(doc(db, 'users', u.id));
            } catch (err) {
                console.error("Error deleting user:", err);
                alert("❌ Error deleting user.");
            }
        };

        /* ===========================
           GST conversion related functions
           These update bills and gstBills collections
           =========================== */
        window.convertToGST = async function () {
            // selected checkboxes hold data-index that map to display order in the current UI.
            let selectedCheckboxes = [...document.querySelectorAll(".billCheck:checked")];
            let selectedIndexes = selectedCheckboxes.map(cb => +cb.dataset.index);

            if (selectedIndexes.length === 0) {
                alert("⚠️ Please select at least one bill!");
                return;
            }

            // Filter out bills that are already marked as Paid
            let billsToConvert = selectedIndexes
                .map(i => billsArr[i])
                .filter(b => b && b.status !== "Paid");

            if (billsToConvert.length === 0) {
                alert("⚠️ Selected bills are already Paid!");
                return;
            }

            // Calculate GST Bill
            let gstBill = {
                gstBillNo: "GST-" + Date.now(),
                date: new Date().toISOString().split("T")[0],
                bills: billsToConvert,
                subTotal: billsToConvert.reduce((sum, b) => sum + (parseFloat(b.total) || 0), 0),
            };
            gstBill.gstAmount = gstBill.subTotal * 0.18; // 18% GST
            gstBill.grandTotal = gstBill.subTotal + gstBill.gstAmount;

            try {
                // Save GST bill
                await addDoc(collection(db, 'gstBills'), { ...gstBill, createdAt: serverTimestamp() });

                // Update original bills' status to "Paid"
                // We must update each bill document individually
                for (let b of billsToConvert) {
                    if (!b.id) continue;
                    await setDoc(doc(db, 'bills', b.id), { ...b, status: "Paid" }, { merge: true });
                }

                // Clear selected checkboxes in UI
                selectedCheckboxes.forEach(cb => cb.checked = false);

                // UI updates via onSnapshot
                alert(`✅ GST created successfully!\nGST Bill No: ${gstBill.gstBillNo}\nTotal GST Amount: ₹${gstBill.gstAmount.toFixed(2)}\nGrand Total: ₹${gstBill.grandTotal.toFixed(2)}`);
            } catch (err) {
                console.error("Error creating GST bill:", err);
                alert("❌ Error creating GST bill.");
            }
        };

        /* updateGST and deleteGSTBill operate on gstBillsArr and update bills' statuses back to Unpaid when a GST bill is deleted */
        window.updateGST = function (index, gstRate) {
            // index refers to the displayed index in gstBillsArr
            let gb = gstBillsArr[index];
            if (!gb) return alert("GST Bill not found.");

            gstRate = parseFloat(gstRate) || 0;
            gb.gstRate = gstRate;
            gb.gstAmount = gb.subTotal * (gstRate / 100);
            gb.grandTotal = gb.subTotal + gb.gstAmount;

            // save back to Firestore
            setDoc(doc(db, 'gstBills', gb.id), { ...gb }, { merge: true })
                .catch(err => {
                    console.error("Error updating GST bill:", err);
                    alert("❌ Error updating GST bill.");
                });
        };

        window.deleteGSTBill = async function (index) {
            if (!confirm("⚠️ Are you sure you want to delete this GST Bill?")) return;
            let gb = gstBillsArr[index];
            if (!gb) return alert("GST Bill not found.");

            try {
                // Revert status of original bills to "Unpaid"
                for (let bill of gb.bills || []) {
                    // find the bill document by billNo (assuming unique)
                    let original = billsArr.find(b => b.billNo === bill.billNo);
                    if (original && original.id) {
                        await setDoc(doc(db, 'bills', original.id), { ...original, status: "Unpaid" }, { merge: true });
                    }
                }

                // delete GST doc
                await deleteDoc(doc(db, 'gstBills', gb.id));
                alert("✅ GST Bill deleted successfully! Original bills status reverted.");
            } catch (err) {
                console.error("Error deleting GST bill:", err);
                alert("❌ Error deleting GST bill.");
            }
        };

        /* ===========================
           Logout: clear local loggedUser reference (keeps same behavior)
           (We keep localStorage.loggedUser usage; authentication is not implemented here.)
           =========================== */
        window.logout = function () {
            // Authentication is beyond scope; preserve existing behavior
            localStorage.removeItem("loggedUser");
            window.location.href = "index.html";
        };



        /* ===========================
           loadGSTBills: renders gstBillsArr
           =========================== */
        function loadGSTBills() {
            const tbody = document.getElementById("gstBillTable");
            if (!tbody) return;
            tbody.innerHTML = "";

            gstBillsArr.forEach((b, index) => {
                tbody.innerHTML += `
<tr>
            <td>${b.date}</td>
            <td>${b.bills && b.bills.length > 0 ? b.bills[0].party : "-"}</td>
            <td>${b.bills ? b.bills.map(x => x.billNo).join(", ") : ""}</td>
            <td>₹${(b.subTotal || 0).toFixed(2)}</td>
            <td>
                <input type="number" class="form-control form-control-sm"
                       value="${b.gstRate || 18}" min="0"
                       oninput="updateGST(${index}, this.value)">
            </td>
            <td id="grandTotal_${index}">
                ₹${b.grandTotal ? b.grandTotal.toFixed(2) : ((b.subTotal || 0) * 1.18).toFixed(2)}
            </td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteGSTBill(${index})">Delete</button>
            </td>
</tr>`;
            });
        }

        /* ===========================
           Window onload equivalent: initialize the real-time listeners and initial render
           =========================== */
        window.addEventListener('DOMContentLoaded', () => {

            // Initialize real-time snapshots
            initRealtimeListeners();

            // Initialize add-item handlers (these will now write to Firestore)
            addItemWithActions('deptForm', 'deptName', 'deptCheckbox', 'departments');
            addItemWithActions('productForm', 'productName', 'productCheckbox', 'products');
            addItemWithActions('processForm', 'processName', 'processCheckbox', 'processes');

            // Other initial UI loads; real-time listeners will handle populating later.
            loadUserDepartments();
            loadUsers();
            refreshDashboard();
            loadMappings();
            renderPartyTable();
            loadFilterDropdowns();
            displayBills(billsArr);
        });
    </script>


</body>
</html> 